<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Amino Acid Quiz — 3D</title>

  <style>
    :root{
      --bg:#0f1115; --panel:#151922; --text:#e6e6e6; --muted:#9aa3b2; --border:#232838;
      --accent:#7aa2ff; --accent2:#55e9bc; --warn:#ffbe55;
    }
    html,body{height:100%;margin:0}
    body{background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);background:#10131d}
    header h1{font-size:16px;margin:0}
    .muted{color:var(--muted);font-size:12px}

    .wrap{display:grid; grid-template-columns:420px 1fr; gap:12px; padding:12px; height:calc(100vh - 58px); box-sizing:border-box;}
    @media (max-width:1100px){ .wrap{ grid-template-columns:1fr; grid-template-rows:auto 1fr; } }

    .panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;display:flex;flex-direction:column;min-height:0}
    .panel h2{margin:0;font-size:14px;padding:10px 12px;border-bottom:1px solid var(--border);color:#cfe0ff}
    .content{padding:10px 12px;overflow:auto;display:flex;flex-direction:column;gap:10px}

    .row{display:flex;gap:8px;align-items:center}
    .row.stacked{flex-direction:column;align-items:stretch}
    label{font-size:12px;color:var(--muted)}
    select,button{background:#0e111a;color:#e6e6e6;border:1px solid var(--border);border-radius:8px;padding:8px;font-size:13px}
    button{cursor:pointer}
    .btn{background:#1a2030;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:13px}
    .btn:hover{border-color:#354068;transform:translateY(-1px)}
    .btn.accent{background:#16213a;border-color:#2b3a66}

    .quiz-wrap{display:grid;grid-template-rows:auto auto 1fr auto;gap:12px;height:100%}
    .canvas-wrap{border:1px solid var(--border);border-radius:10px;background:#0e111a;padding:8px}

    /* >>> keep 3Dmol contained and clickable <<< */
    #mol3d{
      position: relative;
      width:100%; height:420px; border-radius:6px; background:transparent;
    }
    #mol3d > canvas, #mol3d > div{ position:absolute; inset:0; }
    #mol3d canvas{ background:transparent !important }

    .question{font-size:16px}
    .options{display:grid;grid-template-columns:1fr;gap:8px}
    .option{padding:10px 12px;text-align:left}
    .flash-correct{animation: flashGreen 600ms ease}
    .flash-wrong{animation: flashRed 600ms ease}
    @keyframes flashGreen{0%{box-shadow:0 0 0 0 rgba(85,233,188,0)}30%{box-shadow:0 0 0 6px rgba(85,233,188,0.18)}100%{box-shadow:0 0 0 0 rgba(85,233,188,0)}}
    @keyframes flashRed{0%{box-shadow:0 0 0 0 rgba(255,94,94,0)}30%{box-shadow:0 0 0 6px rgba(255,94,94,0.20)}100%{box-shadow:0 0 0 0 rgba(255,94,94,0)}}

    .footer-row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0e1526;border:1px solid #273355;color:#cfe0ff;font-size:12px}
    .hint{color:#b9c4dc}
    small.help{color:var(--muted)}
  </style>

  <script src="https://unpkg.com/3dmol/build/3Dmol-min.js"></script>
</head>
<body>
<header>
  <div>
    <h1>Amino Acid Quiz — 3D</h1>
    <div class="muted">Identify amino acids from their 3D structures. Choose Full name / 3-letter / 1-letter.</div>
  </div>
  <div><span class="pill" id="scorePill">Score: 0 / 0</span></div>
</header>

<div class="wrap">
  <div class="panel">
    <h2>Settings</h2>
    <div class="content">
      <div class="row stacked">
        <label for="quizType">Quiz type</label>
        <select id="quizType">
          <option value="0">Full name</option>
          <option value="1">3-letter code</option>
          <option value="2">1-letter code</option>
        </select>
      </div>
      <div class="row stacked">
        <label for="shuffleMode">Option order</label>
        <select id="shuffleMode">
          <option value="all">Shuffle everything</option>
          <option value="fixed">Keep options stable per question</option>
        </select>
      </div>

      <!-- NEW: include unusual amino acids -->
      <div class="row">
        <label><input type="checkbox" id="includeUnusual"> Include unusual amino acids</label>
      </div>

      <div class="row">
        <button id="startBtn" class="btn accent">Start Quiz</button>
        <button id="resetBtn" class="btn">Reset</button>
      </div>
      <div class="row">
        <button id="showHintBtn" class="btn">Show hint</button>
        <small class="help">Hint shows other codes for the correct answer.</small>
      </div>
      <hr style="border:0;border-top:1px solid var(--border)">
      <small class="help">Drag to rotate. Scroll to zoom. Shift+drag to pan.</small>
    </div>
  </div>

  <div class="panel">
    <h2>Quiz</h2>
    <div class="content quiz-wrap" id="quizRoot">
      <div class="canvas-wrap">
        <div id="mol3d"></div>
      </div>

      <div class="question" id="question">Choose a quiz type and press <b>Start Quiz</b>.</div>

      <div class="options" id="options"></div>

      <div class="footer-row">
        <div class="pill" id="remainingPill">Remaining: 0</div>
        <div class="hint" id="hintArea" hidden></div>
        <div style="display:flex; gap:8px;">
          <button id="skipBtn" class="btn">Skip</button>
          <button id="nextBtn" class="btn">Next</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Standard AAs (20; use L- names where chiral) ---------- */
const STANDARD_AA = [
  ["Glycine","Gly","G","Glycine"],
  ["Alanine","Ala","A","L-Alanine"],
  ["Valine","Val","V","L-Valine"],
  ["Leucine","Leu","L","L-Leucine"],
  ["Isoleucine","Ile","I","L-Isoleucine"],
  ["Proline","Pro","P","L-Proline"],
  ["Phenylalanine","Phe","F","L-Phenylalanine"],
  ["Tyrosine","Tyr","Y","L-Tyrosine"],
  ["Tryptophan","Trp","W","L-Tryptophan"],
  ["Serine","Ser","S","L-Serine"],
  ["Threonine","Thr","T","L-Threonine"],
  ["Cysteine","Cys","C","L-Cysteine"],
  ["Methionine","Met","M","L-Methionine"],
  ["Asparagine","Asn","N","L-Asparagine"],
  ["Glutamine","Gln","Q","L-Glutamine"],
  ["Aspartic acid","Asp","D","L-Aspartic acid"],
  ["Glutamic acid","Glu","E","L-Glutamic acid"],
  ["Lysine","Lys","K","L-Lysine"],
  ["Arginine","Arg","R","L-Arginine"],
  ["Histidine","His","H","L-Histidine"]
];

/* ---------- Unusual AAs (names/synonyms for PubChem fetch) ---------- */
/* The 4th field can be a string OR an array of candidate names. */
const UNUSUAL_AA = [
  ["Selenocysteine","Sec","U", ["L-Selenocysteine","Selenocysteine"]],
  ["Ornithine","Orn","O", ["L-Ornithine","Ornithine"]],
  ["Citrulline","Cit","U*", ["L-Citrulline","Citrulline"]],
  ["4-Hydroxyproline","Hyp","X", ["Trans-4-Hydroxy-L-proline","4-Hydroxy-L-proline","Hydroxyproline"]],
  ["5-Hydroxylysine","Hyl","X*", ["5-Hydroxy-L-lysine","Hydroxylysine"]],
  ["6-N-Methyllysine","MeK","K*", ["N6-Methyl-L-lysine","6-N-Methyl-L-lysine","epsilon-N-Methyl-L-lysine","N6-Methyllysine"]],
  ["γ-Carboxyglutamate","Gla","G*", ["gamma-Carboxy-L-glutamic acid","gamma-Carboxyglutamic acid","Gla"]]
];

/* ---------- State ---------- */
let activeList = [];      // standard or standard+unusual (set at Start)
let pool = [];            // remaining questions
let correct = null;
let options = [];
let score = 0, total = 0, busy = false;
const failed = new Set();

/* ---------- UI ---------- */
const includeUnusualChk = document.getElementById('includeUnusual');
const quizTypeSel = document.getElementById('quizType');
const shuffleModeSel = document.getElementById('shuffleMode');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const showHintBtn = document.getElementById('showHintBtn');
const skipBtn = document.getElementById('skipBtn');
const nextBtn = document.getElementById('nextBtn');
const questionEl = document.getElementById('question');
const optionsEl = document.getElementById('options');
const remainingPill = document.getElementById('remainingPill');
const scorePill = document.getElementById('scorePill');
const hintArea = document.getElementById('hintArea');
const quizRoot = document.getElementById('quizRoot');

/* ---------- 3Dmol viewer ---------- */
const viewer = $3Dmol.createViewer("mol3d",{antialias:true});
viewer.setBackgroundColor(0x000000,0.0); // fully transparent
function clearViewer(){ viewer.removeAllModels(); viewer.zoomTo(); viewer.render(); viewer.resize(); }
window.addEventListener('resize', ()=> viewer.resize());

/* ---------- Helpers ---------- */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]];} return a; }
function sampleDifferent(list, k, exclude){
  const res=[exclude];
  while(res.length<k){
    const c=list[(Math.random()*list.length)|0];
    if(!res.includes(c)) res.push(c);
  }
  return shuffle(res.slice());
}
function updateCounters(){ remainingPill.textContent=`Remaining: ${pool.length}`; scorePill.textContent=`Score: ${score} / ${total}`; }

/* ---------- Audio ---------- */
const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
function beep(freq=880, ms=180, type='sine', gain=0.02){
  if(audioCtx.state==='suspended') audioCtx.resume();
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.value=freq; g.gain.value=gain;
  o.connect(g); g.connect(audioCtx.destination);
  const t=audioCtx.currentTime; o.start(); o.stop(t+ms/1000);
  g.gain.setTargetAtTime(0.0001, t+ms/1000-0.05, 0.03);
}

/* ---------- PubChem 3D fetch with multiple name candidates ---------- */
async function fetchSDF(nameOrNames){
  const names = Array.isArray(nameOrNames) ? nameOrNames : [nameOrNames];

  // Build a deduped list of query strings to try
  const tries = [];
  for(const nm of names){
    const variants = [nm, nm.replace(/^L-/,''), nm.replace(/ /g,'+')];
    for(const v of variants){ if(!tries.includes(v)) tries.push(v); }
  }

  const base = 'https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/';
  const url3d = n => `${base}${encodeURIComponent(n)}/SDF?record_type=3d`;

  for(const q of tries){
    try{
      const r = await fetch(url3d(q), {cache:'no-store'});
      if(r.ok){
        const txt = await r.text();
        if(txt && txt.includes('M  END')) return txt;
      }
    }catch{}
  }
  return null;
}

async function loadModel3D(nameOrNames){
  clearViewer();
  const sdf = await fetchSDF(nameOrNames);
  if(!sdf) return false;
  try{
    viewer.addModel(sdf,'sdf');
    viewer.setStyle({}, {stick:{radius:0.18}, sphere:{scale:0.26}});
    viewer.zoomTo(); viewer.render(); viewer.resize();
    return true;
  }catch{
    clearViewer();
    return false;
  }
}

/* ---------- Quiz Flow ---------- */
async function buildQuestion(){
  if(busy) return; busy = true;

  if(pool.length === 0){
    questionEl.innerHTML = `Quiz complete! <b>Final score:</b> ${score}/${total} (${(score/Math.max(1,total)*100).toFixed(1)}%)`;
    optionsEl.innerHTML = ''; hintArea.hidden = true; busy = false; return;
  }

  hintArea.hidden = true;

  // find next loadable molecule
  let ok=false, candidate=null, attempts=0, max=pool.length+2;
  while(attempts<max && pool.length){
    const c = pool.pop(); attempts++;
    const fetchName = c[3]; // may be string or array
    if(failed.has(JSON.stringify(fetchName))) continue;
    ok = await loadModel3D(fetchName);
    if(ok){ candidate=c; break; }
    failed.add(JSON.stringify(fetchName));
  }

  if(!ok){
    questionEl.innerHTML = `No drawable molecules left. <b>Final score:</b> ${score}/${total} (${(score/Math.max(1,total)*100).toFixed(1)}%)`;
    optionsEl.innerHTML = ''; updateCounters(); busy=false; return;
  }

  correct = candidate;

  const labelIndex = parseInt(quizTypeSel.value,10);
  options = sampleDifferent(activeList, 5, correct);
  if(shuffleModeSel.value !== 'fixed') shuffle(options);

  questionEl.textContent = 'What is this amino acid?';
  optionsEl.innerHTML = '';
  options.forEach((opt, idx)=>{
    const btn = document.createElement('button');
    btn.className = 'btn option';
    btn.textContent = opt[labelIndex];
    btn.onclick = ()=> checkAnswer(idx);
    optionsEl.appendChild(btn);
  });

  updateCounters(); busy=false;
}

function flash(ok){
  quizRoot.classList.remove('flash-correct','flash-wrong');
  void quizRoot.offsetWidth;
  quizRoot.classList.add(ok?'flash-correct':'flash-wrong');
}

function checkAnswer(idx){
  if(busy) return;
  total++;
  if(options[idx] === correct){ score++; beep(1000,160,'sine',0.07); flash(true); }
  else { beep(320,220,'sawtooth',0.05); flash(false); }
  updateCounters(); setTimeout(buildQuestion, 500);
}

/* ---------- Controls ---------- */
function startQuiz(){
  if(busy) return;

  // Build the active list once at game start
  activeList = includeUnusualChk.checked
    ? STANDARD_AA.concat(UNUSUAL_AA)
    : STANDARD_AA.slice();

  score = 0; total = 0; failed.clear();
  pool = shuffle(activeList.slice());      // use only the chosen set
  updateCounters(); buildQuestion();
}

function resetQuiz(){
  if(busy) return;
  score = 0; total = 0;
  pool = []; correct = null; options=[]; failed.clear();
  clearViewer();
  questionEl.innerHTML = 'Choose a quiz type and press <b>Start Quiz</b>.';
  optionsEl.innerHTML = '';
  hintArea.hidden = true;
  updateCounters();
}

function showHint(){
  if(!correct) return;
  hintArea.hidden = false;
  hintArea.innerHTML = `<b>Hint:</b> ${correct[0]} — ${correct[1]} — ${correct[2]}`;
}
function skip(){ if(!busy) buildQuestion(); }
function next(){ if(!busy) buildQuestion(); }

/* ---------- Hooks ---------- */
startBtn.addEventListener('click', startQuiz);
resetBtn.addEventListener('click', resetQuiz);
showHintBtn.addEventListener('click', showHint);
skipBtn.addEventListener('click', skip);
nextBtn.addEventListener('click', next);
</script>
</body>
</html>
